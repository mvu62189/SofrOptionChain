***

### `gitwiki.md`

```markdown
# SABR Options Analysis Pipeline - Wiki

## 1. Overview

This document outlines the features and functionality of the **SABR Options Analysis Pipeline**. This pipeline is a comprehensive toolkit built in Python with Streamlit for analyzing SOFR options markets. It provides functionality for data acquisition, SABR model calibration, and advanced visualization of volatility surfaces, risk-neutral densities (RNDs), and dealer Greeks exposures.

### Minimum Viable Product (MVP) Status

**This application is a Minimum Viable Product (MVP).** Its primary purpose is to provide a platform for testing methodologies, validating models, and identifying key use cases in a real-world context. The insights gained from this MVP will guide the refactoring, optimization, and scaling of the codebase into a robust, production-ready system.

---

## 2. Core Features

### 2.1. Data Acquisition

The pipeline supports two modes of data sourcing:

* **Live Snapshots:** The "Pull New Snapshot" button on the main page connects to the Bloomberg API (`xbbg` and `blpapi`). It fetches the current options chain data for a predefined list of SOFR futures contracts. This data is processed, filtered for liquidity, and saved as `.parquet` files into the `snapshots/YYYYMMDD/HHMMSS/` directory.
* **Historical Analysis:** The application is designed to analyze the `.parquet` files stored in the `snapshots/` directory. This allows users to perform analysis on historical data, compare different market conditions, and run the application without a live Bloomberg connection (local mode). Users can also upload their own compatible `.parquet` files via the sidebar.

### 2.2. SABR Model Calibration

The core of the analytics engine is the SABR model calibration.

* **Model Engines:** Users can seamlessly switch between two underlying pricing models from the sidebar in all modules:
    1.  **Black-76 (Lognormal):** Assumes the underlying asset price is lognormally distributed.
    2.  **Bachelier (Normal):** Assumes the underlying asset price follows a normal distribution.
    This selection impacts implied volatility calculations, SABR parameter calibration, and the subsequent calculation of Greeks.

* **Automated Calibration:** The pipeline uses a robust **Differential Evolution** global optimization algorithm. To ensure stability and accuracy, the calibration is performed on a Vega-weighted, cubic-spline-interpolated volatility curve rather than directly on noisy market data points. This process yields the SABR parameters ($\alpha, \rho, \nu$).

* **Global Beta ($\beta$) Stability:** To prevent overfitting and unstable calibrations, the $\beta$ parameter can be fixed. The "Calibrate Global $\beta$" feature runs an optimization across all selected historical snapshots to find a single, stable $\beta$ that best fits the long-term market dynamics. This value is then saved and used for all individual snapshot calibrations. For the Black-76 and Bachelier models, $\beta$ is fixed to 1.0 and 0.0, respectively.

* **Manual Calibration:** A form in the sidebar allows users to select a single options chain, manually input all four SABR parameters ($\alpha, \beta, \rho, \nu$), and immediately see the resulting model-implied volatility smile plotted against the market.

### 2.3. Analysis & Visualization Pages

The application is divided into several pages, each providing a unique analytical view.

#### Page 1: Volatility & RND

This is the main dashboard for analyzing a single market snapshot.

* **Volatility Smile Plot:** Visualizes the relationship between implied volatility and strike price. It displays three series:
    1.  **Market IV:** Raw implied volatility calculated from OTM option mid-prices.
    2.  **SABR Model IV:** The smooth volatility curve generated by the automatically calibrated SABR parameters.
    3.  **Manual IV:** The curve generated by the user-defined parameters from the sidebar.
* **Risk-Neutral Density (RND) Plot:** Shows the market-implied probability distribution of the future underlying price. The plot compares the RND derived from market option prices (via Breeden-Litzenberger) with the smooth RND implied by the calibrated SABR model.

#### Page 2: IV & RND Surfaces

This page provides a three-dimensional perspective of the options market.

* **3D Surface Visualization:** Renders interactive 3D surfaces for either Implied Volatility or Risk-Neutral Density, plotted against **Strike** and **Time to Maturity**.
* **Market vs. Model Surface:** Two surfaces can be toggled:
    1.  **Market Surface:** Generated by applying a 2D interpolation (linear, cubic, or nearest) across the raw market data points from all selected expiries.
    2.  **SABR Surface:** A smoother, arbitrage-free surface generated by first interpolating the SABR parameters ($\alpha, \rho, \nu, F$) across expiries and then calculating the SABR volatility at each point on the grid.
* **Interactive Slicing:** Sliders in the sidebar allow the user to project 2D slices of the surface onto the plot walls, showing the **volatility skew** for a given maturity or the **term structure** for a given strike.

#### Page 3: Greeks Exposure

This dashboard analyzes aggregate dealer exposure, based on the critical assumption that **dealers are net short the total open interest** for all options.

* **Key Exposure Metrics:** At-a-glance cards display total market-wide exposures:
    * **Total GEX (Gamma Exposure):** The total change in dealer delta for a 1% move in the underlying.
    * **Gamma Flip Point:** The strike price at which the aggregate dealer gamma exposure turns from negative to positive.
    * **Total VEX (Vanna Exposure):** The total change in dealer delta for a 1-point change in implied volatility.
    * **Total Charm, Delta, and Theta exposures.**
* **Exposure Distribution Plots:** Interactive bar charts show how each Greek's exposure is distributed across strikes and expiries. A toggle allows switching between a stacked Call/Put view and a consolidated Net exposure view.
* **Time Series Analysis:** A dedicated tab plots the evolution of the total net exposure for each Greek over time, using all loaded snapshots to reveal trends in market positioning.

---

## 3. User Experience and Behavior

* **Caching:** Data loading and calibration processes are cached using `@st.cache_data`. This means that once a file is processed, it will not be re-processed unless the input parameters (like the model engine) change. A "Clear Cache" button is provided to force a full data reload.
* **State Management:** The application uses `st.session_state` to remember user selections (e.g., selected folder, camera angle for 3D plots) across page navigations and reruns, providing a smoother user experience.
* **Error Handling & Logging:** The application is designed to be robust. If a file fails during processing (e.g., due to insufficient liquid options), it is skipped, and a detailed log of all skipped files is presented to the user in an expandable section on the UI.
* **Performance:** Users should be aware that processing a large number of snapshots or running the global beta calibration can be computationally intensive and may require some time to complete.

---

## 4. MVP Limitations & Future Work

As an MVP, this version has several areas planned for improvement in a future production release:

* **Code Refactoring:** The current codebase will be refactored to improve modularity, eliminate redundancy, and enhance performance.
* **Data Pipeline:** The data ingestion and handling modules will integrate more advanced logic (filtering, storing,...)
* **Scalability:** Calculations and data-structures will be optimized for handling larger datasets and more frequent updates.
* **Expanded Model Library:** Future versions may incorporate alternative volatility models for comparison, and additional features with confirmed usecases
* **Testing Framework:** A comprehensive suite of unit and integration tests will be developed to ensure reliability and accuracy.
